<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShopX - Admin</title>
  <link rel="stylesheet" href="./assets/css/style-prefix.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
  <main class="container section">
    <h1>Admin Portal</h1>
    <p class="muted">Only admins can access. Admin flag is stored on the user document.</p>

    <section class="section">
      <h2>New / Edit Product</h2>
      <form id="prod-form">
        <input type="hidden" id="prod-id" />
        <div class="form-row">
          <div><label>Title</label><input id="prod-title" class="input" required></div>
          <div><label>Category</label><input id="prod-cat" class="input"></div>
        </div>
        <div class="form-row">
          <div><label>MSRP</label><input id="prod-msrp" class="input" type="number" min="0" step="0.01" required></div>
          <div><label>Price (Retailer)</label><input id="prod-pr" class="input" type="number" min="0" step="0.01" required></div>
        </div>
        <div class="form-row">
          <div><label>Price (Company)</label><input id="prod-pc" class="input" type="number" min="0" step="0.01" required></div>
          <div><label>Stock</label><input id="prod-stock" class="input" type="number" min="0" step="1" value="0"></div>
        </div>
        <div><label>Image URL</label><input id="prod-img" class="input" placeholder="https://..."></div>
        <div><label>Description</label><textarea id="prod-desc" class="input"></textarea></div>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <label><input type="checkbox" id="prod-active" checked> Active</label>
          <button type="submit">Save</button>
          <button type="button" id="reset" class="ghost">Reset</button>
        </div>
      </form>
    </section>

    <section class="section">
      <h2>Products</h2>
      <div id="prods"></div>
    </section>

    <section class="section">
      <h2>Orders</h2>
      <div id="orders"></div>
    </section>
  </main>

  <script type="module">
    import { onAuthChange } from './assets/js/app.js';
    import { adminUpsertProduct, adminDeleteProduct, adminListOrders, adminAssignOrder } from './assets/js/app.js';
    import { getFirestoreInstance } from './assets/js/firebase.js';
    import './assets/js/firebase.js';

    const db = getFirestoreInstance();
    let user=null, profile=null;
    onAuthChange((u,p)=>{ user=u; profile=p; if(!u) { location.href='/ecommerce/login.html'; return; } if(!p?.isAdmin){ document.body.innerHTML='<main class="container section"><h2>Access denied</h2><p>Admin only.</p></main>'; } else { init(); } });

    function readForm() {
      return {
        id: document.getElementById('prod-id').value || undefined,
        title: document.getElementById('prod-title').value.trim(),
        category: document.getElementById('prod-cat').value.trim(),
        msrp: parseFloat(document.getElementById('prod-msrp').value||'0'),
        priceRetailer: parseFloat(document.getElementById('prod-pr').value||'0'),
        priceCompany: parseFloat(document.getElementById('prod-pc').value||'0'),
        stock: parseInt(document.getElementById('prod-stock').value||'0',10),
        imageUrl: document.getElementById('prod-img').value.trim(),
        description: document.getElementById('prod-desc').value.trim(),
        active: document.getElementById('prod-active').checked,
        updatedAt: window.firebase.firestore.FieldValue.serverTimestamp(),
      };
    }
    function writeForm(p) {
      document.getElementById('prod-id').value = p?.id || '';
      document.getElementById('prod-title').value = p?.title || '';
      document.getElementById('prod-cat').value = p?.category || '';
      document.getElementById('prod-msrp').value = p?.msrp || '';
      document.getElementById('prod-pr').value = p?.priceRetailer || '';
      document.getElementById('prod-pc').value = p?.priceCompany || '';
      document.getElementById('prod-stock').value = p?.stock || 0;
      document.getElementById('prod-img').value = p?.imageUrl || '';
      document.getElementById('prod-desc').value = p?.description || '';
      document.getElementById('prod-active').checked = !!p?.active;
    }

    async function loadProducts() {
      const snap = await db.collection('products').orderBy('title').get();
      const data = snap.docs.map(d=>({id:d.id, ...d.data()}));
      const html = [`<table class="table"><thead><tr><th>Title</th><th>Retailer</th><th>Company</th><th>Active</th><th></th></tr></thead><tbody>`];
      for(const p of data){
        html.push(`<tr><td>${p.title}</td><td>$${(p.priceRetailer||0).toFixed(2)}</td><td>$${(p.priceCompany||0).toFixed(2)}</td><td>${p.active?'Yes':'No'}</td><td><button data-edit="${p.id}">Edit</button> <button data-del="${p.id}" class="ghost">Delete</button></td></tr>`);
      }
      html.push('</tbody></table>');
      const container = document.getElementById('prods');
      container.innerHTML = html.join('');
      container.querySelectorAll('button[data-edit]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-edit');
        const d = await db.collection('products').doc(id).get();
        writeForm({ id, ...d.data() });
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }));
      container.querySelectorAll('button[data-del]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-del');
        if (confirm('Delete product?')) { await adminDeleteProduct(id); await loadProducts(); }
      }));
    }

    async function loadOrders() {
      const ords = await adminListOrders();
      if(!ords.length){ document.getElementById('orders').innerHTML = '<p>No orders yet.</p>'; return; }
      const rows = ords.map(o=>`<tr><td>${o.id}</td><td>${o.userEmail}</td><td>${o.items.length}</td><td>$${(o.subtotal||0).toFixed(2)}</td><td>${o.status}</td><td><input class="input" placeholder="Delivery UID" value="${o.assignedDeliveryUserId||''}" data-uid="${o.id}"></td><td><button data-assign="${o.id}">Assign</button></td></tr>`).join('');
      document.getElementById('orders').innerHTML = `<table class="table"><thead><tr><th>ID</th><th>User</th><th>Items</th><th>Total</th><th>Status</th><th>Delivery UID</th><th></th></tr></thead><tbody>${rows}</tbody></table>`;
      document.querySelectorAll('button[data-assign]').forEach(btn=> btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-assign');
        const uid = document.querySelector(`input[data-uid="${id}"]`).value.trim();
        if (!uid) { alert('Enter delivery UID'); return; }
        await adminAssignOrder(id, uid);
        await loadOrders();
      }));
    }

    function init(){
      document.getElementById('prod-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const data = readForm();
        if (!data.title) return alert('Title required');
        await adminUpsertProduct({
          ...data,
          createdAt: data.id ? undefined : window.firebase.firestore.FieldValue.serverTimestamp(),
          active: !!data.active,
        });
        alert('Saved');
        writeForm(null);
        await loadProducts();
      });
      document.getElementById('reset').addEventListener('click', ()=> writeForm(null));
      loadProducts();
      loadOrders();
    }
  </script>
</body>
</html>